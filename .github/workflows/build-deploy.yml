name: Deploy

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore tests/Hex1b.Tests/Hex1b.Tests.csproj

      - name: Build
        run: dotnet build tests/Hex1b.Tests/Hex1b.Tests.csproj --no-restore

      - name: Run tests
        run: |
          dotnet test tests/Hex1b.Tests/Hex1b.Tests.csproj \
            --no-build \
            --logger "trx;LogFileName=test-results.trx" \
            --results-directory ./TestResults

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Test Results
          path: ./TestResults/*.trx
          reporter: dotnet-trx

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: test-results
          path: ./TestResults/

      - name: Upload SVG attachments
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: svg-attachments
          path: tests/Hex1b.Tests/bin/Debug/net10.0/TestResults/svg/
          if-no-files-found: ignore

  build-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        uses: ./.github/actions/version

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build and pack (PR version for GH Packages)
        run: |
          dotnet pack src/Hex1b/Hex1b.csproj -c Release -p:PackageVersion=${{ steps.version.outputs.pr }} -o ./artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages-pr
          path: ./artifacts/*.nupkg

  build-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        uses: ./.github/actions/version

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build and pack (release version for NuGet.org)
        run: |
          dotnet pack src/Hex1b/Hex1b.csproj -c Release -p:PackageVersion=${{ steps.version.outputs.release }} -o ./artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages-release
          path: ./artifacts/*.nupkg

  publish-pr:
    runs-on: ubuntu-latest
    needs: [build-pr, test]
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        uses: ./.github/actions/version

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages-pr
          path: ./artifacts

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Push to GitHub Packages
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
            --api-key ${{ secrets.GITHUB_TOKEN }}

      - name: Post package info to PR
        env:
          GH_TOKEN: ${{ github.token }}
          PACKAGE_VERSION: ${{ steps.version.outputs.pr }}
        run: |
          set -e
          
          # Delete previous package comments to avoid noise
          gh pr view ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --json comments \
            --jq '.comments[]? | select(.body | startswith("## ðŸ“¦ PR Package Published")) | .databaseId' 2>/dev/null | \
          while IFS= read -r comment_id; do
            if [ -n "$comment_id" ]; then
              echo "Deleting old package comment: $comment_id"
              gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/repos/${{ github.repository }}/issues/comments/$comment_id" || true
            fi
          done

          # Create comment body
          cat > /tmp/pr_comment.md << EOF
          ## ðŸ“¦ PR Package Published

          A preview package for this PR has been published to GitHub Packages.

          ### Package Version
          \`${PACKAGE_VERSION}\`

          ### Usage Examples

          **PackageReference (csproj):**
          \`\`\`xml
          <PackageReference Include="Hex1b" Version="${PACKAGE_VERSION}" />
          \`\`\`

          **Polyglot Notebooks / .NET Interactive:**
          \`\`\`csharp
          #:package Hex1b@${PACKAGE_VERSION}"
          \`\`\`

          **.NET CLI:**
          \`\`\`bash
          dotnet add package Hex1b --version ${PACKAGE_VERSION}
          \`\`\`

          ### NuGet Configuration

          To use this package, you need to configure a NuGet.config file with the GitHub Packages feed:

          \`\`\`xml
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <packageSources>
              <!--To inherit the global NuGet package sources remove the <clear/> line below -->
              <clear />
              <add key="nuget" value="https://api.nuget.org/v3/index.json" />
              <add key="github-mitchdenny" value="https://nuget.pkg.github.com/mitchdenny/index.json" />
            </packageSources>
            <packageSourceMapping>
              <packageSource key="nuget">
                <package pattern="*" />
              </packageSource>
              <packageSource key="github-mitchdenny">
                <package pattern="Hex1b*" />
              </packageSource>
            </packageSourceMapping>
          </configuration>
          \`\`\`

          ### Authentication

          GitHub Packages requires authentication. Make sure your GitHub CLI has the \`read:packages\` scope:

          \`\`\`bash
          # Check current scopes
          gh auth status

          # If needed, refresh with packages scope
          gh auth refresh -s read:packages

          # Configure NuGet to use GitHub auth
          dotnet nuget update source github-mitchdenny \\
            --username YOUR_GITHUB_USERNAME \\
            --password \$(gh auth token) \\
            --store-password-in-clear-text
          \`\`\`

          ---
          *Package published at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

          # Strip leading spaces
          sed -i 's/^          //' /tmp/pr_comment.md

          # Post comment to PR
          gh pr comment ${{ github.event.pull_request.number }} \
            --body-file /tmp/pr_comment.md \
            --repo ${{ github.repository }}

  publish-release:
    runs-on: ubuntu-latest
    needs: [build-release, test]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: production
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        uses: ./.github/actions/version

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages-release
          path: ./artifacts

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Check if package exists on NuGet.org
        id: check-package
        run: |
          PACKAGE_VERSION="${{ steps.version.outputs.release }}"
          echo "Checking if Hex1b version $PACKAGE_VERSION exists on NuGet.org..."
          
          # Try to get package info from NuGet API
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.nuget.org/v3-flatcontainer/hex1b/$PACKAGE_VERSION/hex1b.nuspec")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Package version $PACKAGE_VERSION already exists on NuGet.org"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Package version $PACKAGE_VERSION does not exist on NuGet.org"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to NuGet
        if: steps.check-package.outputs.exists == 'false'
        uses: nuget/login@v1
        id: nugetlogin
        with:
          user: ${{ secrets.NUGET_USERNAME }}

      - name: Push to NuGet.org
        if: steps.check-package.outputs.exists == 'false'
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --api-key ${{ steps.nugetlogin.outputs.NUGET_API_KEY }} \
            --source "https://api.nuget.org/v3/index.json" \
            --skip-duplicate

      - name: Create GitHub Release
        if: steps.check-package.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
          PACKAGE_VERSION: ${{ steps.version.outputs.release }}
        run: |
          # Create release notes
          cat > /tmp/release_notes.md << EOF
          ## Hex1b v${PACKAGE_VERSION}

          ### Installation

          **NuGet CLI:**
          \`\`\`bash
          dotnet add package Hex1b --version ${PACKAGE_VERSION}
          \`\`\`

          **PackageReference:**
          \`\`\`xml
          <PackageReference Include="Hex1b" Version="${PACKAGE_VERSION}" />
          \`\`\`

          ### Links
          - ðŸ“¦ [NuGet Package](https://www.nuget.org/packages/Hex1b/${PACKAGE_VERSION})
          - ðŸ“– [Documentation](https://hex1b.dev)

          ---
          *Released from commit ${{ github.sha }}*
          EOF

          # Create the GitHub release with the nupkg attached
          gh release create "v${PACKAGE_VERSION}" \
            --title "v${PACKAGE_VERSION}" \
            --notes-file /tmp/release_notes.md \
            ./artifacts/*.nupkg

  deploy-pullrequest:
    runs-on: ubuntu-latest
    needs: publish-pr
    if: github.event_name == 'pull_request'
    environment: pullrequest
    concurrency:
      group: deploy-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    permissions:
      contents: read
      id-token: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Download and install Aspire CLI
        run: |
          set -e
          curl -sSL https://aspire.dev/install.sh | bash -s
          echo "$HOME/.aspire/bin" >> $GITHUB_PATH

      - name: Show Aspire CLI version
        run: |
          set -e
          aspire --version

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run aspire deploy
        env:
          AZURE__SUBSCRIPTIONID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE__LOCATION: 'westus3'
          AZURE__RESOURCEGROUP: 'hex1b-pr-${{ github.event.pull_request.number }}'
        run: |
          set -e
          aspire deploy

      - name: Get Azure resource details
        id: azure-resources
        env:
          RESOURCE_GROUP: 'hex1b-pr-${{ github.event.pull_request.number }}'
          SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          set -e
          # Get the container app environment name (assume there's only one)
          CAE_NAME=$(az containerapp env list \
            --resource-group "$RESOURCE_GROUP" \
            --subscription "$SUBSCRIPTION_ID" \
            --query "[0].name" -o tsv)

          if [ -z "$CAE_NAME" ]; then
            echo "Warning: No container app environment found in resource group"
            echo "cae-name=Not available" >> $GITHUB_OUTPUT
          else
            echo "cae-name=$CAE_NAME" >> $GITHUB_OUTPUT
          fi

          # Get the website container app URL
          WEBSITE_URL=$(az containerapp list \
            --resource-group "$RESOURCE_GROUP" \
            --subscription "$SUBSCRIPTION_ID" \
            --query "[?contains(name, 'website')].properties.configuration.ingress.fqdn" -o tsv)

          if [ -n "$WEBSITE_URL" ]; then
            echo "website-url=https://$WEBSITE_URL" >> $GITHUB_OUTPUT
          else
            echo "website-url=Not available" >> $GITHUB_OUTPUT
          fi

      - name: Post deployment info to PR
        env:
          GH_TOKEN: ${{ github.token }}
          RESOURCE_GROUP: 'hex1b-pr-${{ github.event.pull_request.number }}'
          SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          CAE_NAME: ${{ steps.azure-resources.outputs.cae-name }}
          WEBSITE_URL: ${{ steps.azure-resources.outputs.website-url }}
        run: |
          set -e
          # Delete previous deployment comments to avoid noise
          # Get all comments from the PR and filter for deployment comments, then delete them
          gh pr view ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --json comments \
            --jq '.comments[]? | select(.body | startswith("## ðŸš€ Deployment Successful")) | .databaseId' 2>/dev/null | \
          while IFS= read -r comment_id; do
            if [ -n "$comment_id" ]; then
              echo "Deleting old deployment comment: $comment_id"
              gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/repos/${{ github.repository }}/issues/comments/$comment_id" || true
            fi
          done

          # Generate Azure Portal URLs
          RG_URL="https://portal.azure.com/#@/resource/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/overview"

          # Create comment body
          cat > /tmp/pr_comment.md << 'EOF'
          ## ðŸš€ Deployment Successful

          Your PR environment has been deployed to Azure!

          ### Resources
          - ðŸ“¦ [Resource Group: `RESOURCE_GROUP_PLACEHOLDER`](RG_URL_PLACEHOLDER)
          EOF

          # Strip leading spaces (10 spaces of indentation)
          sed -i 's/^          //' /tmp/pr_comment.md

          # Add CAE link only if available
          if [ "$CAE_NAME" != "Not available" ]; then
            CAE_URL="https://portal.azure.com/#@/resource/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.App/managedEnvironments/${CAE_NAME}/overview"
            echo "- ðŸ—ï¸ [Container App Environment: \`${CAE_NAME}\`](${CAE_URL})" >> /tmp/pr_comment.md
          else
            echo "- ðŸ—ï¸ Container App Environment: ${CAE_NAME}" >> /tmp/pr_comment.md
          fi

          # Add website URL (conditionally format as link)
          if [ "$WEBSITE_URL" != "Not available" ]; then
            echo "- ðŸŒ [Website URL](${WEBSITE_URL})" >> /tmp/pr_comment.md
          else
            echo "- ðŸŒ Website URL: ${WEBSITE_URL}" >> /tmp/pr_comment.md
          fi

          # Add footer
          cat >> /tmp/pr_comment.md << 'EOF'

          ---
          *Deployment completed at TIMESTAMP_PLACEHOLDER*
          EOF

          # Strip leading spaces from footer
          tail -n 3 /tmp/pr_comment.md | sed 's/^          //' > /tmp/pr_comment_footer.md
          head -n -3 /tmp/pr_comment.md > /tmp/pr_comment_body.md
          cat /tmp/pr_comment_body.md /tmp/pr_comment_footer.md > /tmp/pr_comment.md

          # Replace placeholders
          sed -i "s|RESOURCE_GROUP_PLACEHOLDER|${RESOURCE_GROUP}|g" /tmp/pr_comment.md
          sed -i "s|RG_URL_PLACEHOLDER|${RG_URL}|g" /tmp/pr_comment.md
          sed -i "s|TIMESTAMP_PLACEHOLDER|$(date -u '+%Y-%m-%d %H:%M:%S UTC')|g" /tmp/pr_comment.md

          # Post comment to PR
          gh pr comment ${{ github.event.pull_request.number }} \
            --body-file /tmp/pr_comment.md \
            --repo ${{ github.repository }}

  deploy-production:
    runs-on: ubuntu-latest
    needs: publish-release
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: production
    concurrency:
      group: deploy-production
      cancel-in-progress: false
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Download and install Aspire CLI
        run: |
          set -e
          curl -sSL https://aspire.dev/install.sh | bash -s -- -q dev
          echo "$HOME/.aspire/bin" >> $GITHUB_PATH

      - name: Show Aspire CLI version
        run: |
          set -e
          aspire --version

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run aspire deploy
        env:
          AZURE__SUBSCRIPTIONID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE__LOCATION: 'westus3'
          AZURE__RESOURCEGROUP: 'hex1b-production'
          Parameters__customDomain: ${{ vars.CUSTOM_DOMAIN }}
          Parameters__certificateName: ${{ secrets.CERTIFICATE_NAME }}
        run: |
          set -e
          aspire deploy
