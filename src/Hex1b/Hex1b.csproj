<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <GenerateDocumentationFile>true</GenerateDocumentationFile>
    <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
    <NoWarn>$(NoWarn);CS1591</NoWarn>

    <!-- Embed source code for debugging -->
    <EmbedAllSources>true</EmbedAllSources>
    <DebugType>embedded</DebugType>
    <DebugSymbols>true</DebugSymbols>

    <!-- Package Metadata -->
    <PackageId>Hex1b</PackageId>
    <Title>Hex1b</Title>
    <Authors>Mitch Denny</Authors>
    <Copyright>Copyright (c) 2024 Mitch Denny</Copyright>
    <Description>Build user interfaces for terminal apps using an approachable code-first API.</Description>
    <PackageTags>tui;terminal;console;ui;widgets;ansi;cli</PackageTags>
    
    <!-- License -->
    <PackageLicenseExpression>MIT</PackageLicenseExpression>
    
    <!-- Repository -->
    <RepositoryUrl>https://github.com/mitchdenny/hex1b</RepositoryUrl>
    <RepositoryType>git</RepositoryType>
    <PackageProjectUrl>https://github.com/mitchdenny/hex1b</PackageProjectUrl>
    
    <!-- README -->
    <PackageReadmeFile>README.md</PackageReadmeFile>
    
    <!-- Release Notes -->
    <PackageReleaseNotes>See https://github.com/hex1b/hex1b/releases for release notes.</PackageReleaseNotes>
    
    <!-- Additional Package Settings -->
    <PackageRequireLicenseAcceptance>false</PackageRequireLicenseAcceptance>
  </PropertyGroup>

  <ItemGroup>
    <InternalsVisibleTo Include="Hex1b.Tests" />
    <InternalsVisibleTo Include="Hex1b.Benchmarks" />
    <InternalsVisibleTo Include="Hex1b.Tool" />
    <InternalsVisibleTo Include="Hex1b.Tool.Tests" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="QRCoder" Version="1.7.0" />
  </ItemGroup>

  <ItemGroup>
    <None Include="README.md" Pack="true" PackagePath="/" />
  </ItemGroup>

  <!-- 
    Native interop library for Unix platforms (hex1binterop)
    
    The runtimes folder structure follows NuGet conventions:
      runtimes/{RID}/native/{library}
    
    When packed, these get placed in the NuGet package under runtimes/
    and .NET's runtime loader automatically finds them based on the current RID.
  -->

  <!-- Determine native library paths based on platform -->
  <PropertyGroup Condition="$([MSBuild]::IsOSPlatform('Linux'))">
    <NativeLibraryName>libhex1binterop.so</NativeLibraryName>
    <NativeLibraryRid Condition="'$([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture)' == 'Arm64'">linux-arm64</NativeLibraryRid>
    <NativeLibraryRid Condition="'$(NativeLibraryRid)' == ''">linux-x64</NativeLibraryRid>
  </PropertyGroup>
  <PropertyGroup Condition="$([MSBuild]::IsOSPlatform('OSX'))">
    <NativeLibraryName>libhex1binterop.dylib</NativeLibraryName>
    <NativeLibraryRid Condition="'$([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture)' == 'Arm64'">osx-arm64</NativeLibraryRid>
    <NativeLibraryRid Condition="'$(NativeLibraryRid)' == ''">osx-x64</NativeLibraryRid>
  </PropertyGroup>
  <PropertyGroup Condition="'$(NativeLibraryRid)' != ''">
    <NativeLibraryPath>$(MSBuildThisFileDirectory)runtimes/$(NativeLibraryRid)/native/$(NativeLibraryName)</NativeLibraryPath>
  </PropertyGroup>

  <!-- Build native library if it doesn't exist (Linux/macOS only) -->
  <Target Name="BuildNativeInteropLibrary" 
          BeforeTargets="BeforeBuild" 
          Condition="'$(NativeLibraryPath)' != '' and !Exists('$(NativeLibraryPath)')">
    <Message Importance="High" Text="Building native interop library ($(NativeLibraryName))..." />
    <Exec Command="make" WorkingDirectory="$(MSBuildThisFileDirectory)native" />
  </Target>

  <!-- Copy native library to output after build (handles freshly built libraries) -->
  <Target Name="CopyNativeInteropLibrary" 
          AfterTargets="Build" 
          Condition="'$(NativeLibraryPath)' != '' and Exists('$(NativeLibraryPath)')">
    <Copy SourceFiles="$(NativeLibraryPath)" 
          DestinationFiles="$(OutputPath)$(NativeLibraryName)" 
          SkipUnchangedFiles="true" />
  </Target>
  
  <!-- Pack native libraries into NuGet package -->
  <ItemGroup>
    <None Include="runtimes/linux-x64/native/libhex1binterop.so" 
          Condition="Exists('runtimes/linux-x64/native/libhex1binterop.so')"
          Pack="true" 
          PackagePath="runtimes/linux-x64/native" />
    <None Include="runtimes/linux-arm64/native/libhex1binterop.so" 
          Condition="Exists('runtimes/linux-arm64/native/libhex1binterop.so')"
          Pack="true" 
          PackagePath="runtimes/linux-arm64/native" />
    <None Include="runtimes/osx-x64/native/libhex1binterop.dylib" 
          Condition="Exists('runtimes/osx-x64/native/libhex1binterop.dylib')"
          Pack="true" 
          PackagePath="runtimes/osx-x64/native" />
    <None Include="runtimes/osx-arm64/native/libhex1binterop.dylib" 
          Condition="Exists('runtimes/osx-arm64/native/libhex1binterop.dylib')"
          Pack="true" 
          PackagePath="runtimes/osx-arm64/native" />
  </ItemGroup>
  
  <!-- 
    Copy native library to output for local development (non-RID-specific builds)
    Using Content items with CopyToOutputDirectory ensures transitive copying
    to consuming projects via ProjectReference.
  -->
  <ItemGroup Condition="'$(RuntimeIdentifier)' == '' and $([MSBuild]::IsOSPlatform('Linux'))">
    <Content Include="runtimes/linux-x64/native/libhex1binterop.so" 
             Condition="Exists('runtimes/linux-x64/native/libhex1binterop.so')"
             CopyToOutputDirectory="PreserveNewest"
             CopyToPublishDirectory="PreserveNewest"
             Link="libhex1binterop.so" />
  </ItemGroup>
  
  <ItemGroup Condition="'$(RuntimeIdentifier)' == '' and $([MSBuild]::IsOSPlatform('OSX'))">
    <Content Include="runtimes/osx-arm64/native/libhex1binterop.dylib" 
             Condition="Exists('runtimes/osx-arm64/native/libhex1binterop.dylib')"
             CopyToOutputDirectory="PreserveNewest"
             CopyToPublishDirectory="PreserveNewest"
             Link="libhex1binterop.dylib" />
    <Content Include="runtimes/osx-x64/native/libhex1binterop.dylib" 
             Condition="Exists('runtimes/osx-x64/native/libhex1binterop.dylib') and !Exists('runtimes/osx-arm64/native/libhex1binterop.dylib')"
             CopyToOutputDirectory="PreserveNewest"
             CopyToPublishDirectory="PreserveNewest"
             Link="libhex1binterop.dylib" />
  </ItemGroup>
  
  <!-- For RID-specific builds, copy the matching native library -->
  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'linux-x64'">
    <Content Include="runtimes/linux-x64/native/libhex1binterop.so" 
             Condition="Exists('runtimes/linux-x64/native/libhex1binterop.so')"
             CopyToOutputDirectory="PreserveNewest"
             CopyToPublishDirectory="PreserveNewest"
             Link="libhex1binterop.so" />
  </ItemGroup>
  
  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'linux-arm64'">
    <Content Include="runtimes/linux-arm64/native/libhex1binterop.so" 
             Condition="Exists('runtimes/linux-arm64/native/libhex1binterop.so')"
             CopyToOutputDirectory="PreserveNewest"
             CopyToPublishDirectory="PreserveNewest"
             Link="libhex1binterop.so" />
  </ItemGroup>
  
  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'osx-x64'">
    <Content Include="runtimes/osx-x64/native/libhex1binterop.dylib" 
             Condition="Exists('runtimes/osx-x64/native/libhex1binterop.dylib')"
             CopyToOutputDirectory="PreserveNewest"
             CopyToPublishDirectory="PreserveNewest"
             Link="libhex1binterop.dylib" />
  </ItemGroup>
  
  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'osx-arm64'">
    <Content Include="runtimes/osx-arm64/native/libhex1binterop.dylib" 
             Condition="Exists('runtimes/osx-arm64/native/libhex1binterop.dylib')"
             CopyToOutputDirectory="PreserveNewest"
             CopyToPublishDirectory="PreserveNewest"
             Link="libhex1binterop.dylib" />
  </ItemGroup>

  <!--
    Ensure the native library is included in transitive output even when built dynamically.
    This target hooks into GetCopyToOutputDirectoryItems which is called by consuming projects.
  -->
  <Target Name="IncludeNativeLibraryInCopyToOutput" 
          BeforeTargets="GetCopyToOutputDirectoryItems"
          DependsOnTargets="BuildNativeLibraryLinuxX64;BuildNativeLibraryLinuxArm64;BuildNativeLibraryOsxX64;BuildNativeLibraryOsxArm64"
          Condition="'$(RuntimeIdentifier)' == ''">
    <!-- Add native library to AllItemsFullPathWithTargetPath for transitive copy -->
    <ItemGroup Condition="$([MSBuild]::IsOSPlatform('Linux')) and Exists('$(MSBuildProjectDirectory)/runtimes/linux-x64/native/libhex1binterop.so')">
      <AllItemsFullPathWithTargetPath Include="$(MSBuildProjectDirectory)/runtimes/linux-x64/native/libhex1binterop.so">
        <TargetPath>libhex1binterop.so</TargetPath>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </AllItemsFullPathWithTargetPath>
      <ContentWithTargetPath Include="$(MSBuildProjectDirectory)/runtimes/linux-x64/native/libhex1binterop.so">
        <TargetPath>libhex1binterop.so</TargetPath>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </ContentWithTargetPath>
    </ItemGroup>
    <ItemGroup Condition="$([MSBuild]::IsOSPlatform('OSX')) and Exists('$(MSBuildProjectDirectory)/runtimes/osx-arm64/native/libhex1binterop.dylib')">
      <AllItemsFullPathWithTargetPath Include="$(MSBuildProjectDirectory)/runtimes/osx-arm64/native/libhex1binterop.dylib">
        <TargetPath>libhex1binterop.dylib</TargetPath>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </AllItemsFullPathWithTargetPath>
      <ContentWithTargetPath Include="$(MSBuildProjectDirectory)/runtimes/osx-arm64/native/libhex1binterop.dylib">
        <TargetPath>libhex1binterop.dylib</TargetPath>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </ContentWithTargetPath>
    </ItemGroup>
    <ItemGroup Condition="$([MSBuild]::IsOSPlatform('OSX')) and !Exists('$(MSBuildProjectDirectory)/runtimes/osx-arm64/native/libhex1binterop.dylib') and Exists('$(MSBuildProjectDirectory)/runtimes/osx-x64/native/libhex1binterop.dylib')">
      <AllItemsFullPathWithTargetPath Include="$(MSBuildProjectDirectory)/runtimes/osx-x64/native/libhex1binterop.dylib">
        <TargetPath>libhex1binterop.dylib</TargetPath>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </AllItemsFullPathWithTargetPath>
      <ContentWithTargetPath Include="$(MSBuildProjectDirectory)/runtimes/osx-x64/native/libhex1binterop.dylib">
        <TargetPath>libhex1binterop.dylib</TargetPath>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </ContentWithTargetPath>
    </ItemGroup>
  </Target>

  <!--
    Automatic native library building for local development
    
    This target builds the native interop library if it doesn't exist.
    In CI, the native libraries are built in separate jobs on each platform,
    then binplaced before dotnet pack. This target is a fallback for local
    development when the library hasn't been built yet.
  -->
  
  <!-- Linux x64: Build native library if it doesn't exist -->
  <Target Name="BuildNativeLibraryLinuxX64" 
          BeforeTargets="BeforeBuild"
          Condition="$([MSBuild]::IsOSPlatform('Linux')) and '$([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture)' == 'X64' and !Exists('runtimes/linux-x64/native/libhex1binterop.so')">
    <Message Importance="high" Text="Building hex1binterop native library for linux-x64..." />
    <Exec Command="make" WorkingDirectory="$(MSBuildProjectDirectory)/native" IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="MakeExitCode" />
    </Exec>
    <Warning Condition="'$(MakeExitCode)' != '0'" Text="Failed to build native library. PTY features may not work. Ensure gcc and make are installed." />
  </Target>
  
  <!-- Linux arm64: Build native library if it doesn't exist -->
  <Target Name="BuildNativeLibraryLinuxArm64" 
          BeforeTargets="BeforeBuild"
          Condition="$([MSBuild]::IsOSPlatform('Linux')) and '$([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture)' == 'Arm64' and !Exists('runtimes/linux-arm64/native/libhex1binterop.so')">
    <Message Importance="high" Text="Building hex1binterop native library for linux-arm64..." />
    <Exec Command="make" WorkingDirectory="$(MSBuildProjectDirectory)/native" IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="MakeExitCode" />
    </Exec>
    <Warning Condition="'$(MakeExitCode)' != '0'" Text="Failed to build native library. PTY features may not work. Ensure gcc and make are installed." />
  </Target>
  
  <!-- macOS x64: Build native library if it doesn't exist -->
  <Target Name="BuildNativeLibraryOsxX64" 
          BeforeTargets="BeforeBuild"
          Condition="$([MSBuild]::IsOSPlatform('OSX')) and '$([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture)' == 'X64' and !Exists('runtimes/osx-x64/native/libhex1binterop.dylib')">
    <Message Importance="high" Text="Building hex1binterop native library for osx-x64..." />
    <Exec Command="make" WorkingDirectory="$(MSBuildProjectDirectory)/native" IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="MakeExitCode" />
    </Exec>
    <Warning Condition="'$(MakeExitCode)' != '0'" Text="Failed to build native library. PTY features may not work. Ensure Xcode Command Line Tools are installed." />
  </Target>
  
  <!-- macOS arm64: Build native library if it doesn't exist -->
  <Target Name="BuildNativeLibraryOsxArm64" 
          BeforeTargets="BeforeBuild"
          Condition="$([MSBuild]::IsOSPlatform('OSX')) and '$([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture)' == 'Arm64' and !Exists('runtimes/osx-arm64/native/libhex1binterop.dylib')">
    <Message Importance="high" Text="Building hex1binterop native library for osx-arm64..." />
    <Exec Command="make" WorkingDirectory="$(MSBuildProjectDirectory)/native" IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="MakeExitCode" />
    </Exec>
    <Warning Condition="'$(MakeExitCode)' != '0'" Text="Failed to build native library. PTY features may not work. Ensure Xcode Command Line Tools are installed." />
  </Target>

</Project>
